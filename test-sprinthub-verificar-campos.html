<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificar Campos SprintHub</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .error {
            color: #ff6b6b;
        }
        .success {
            color: #51cf66;
        }
        .info {
            color: #74c0fc;
        }
    </style>
</head>
<body>
    <h1>üîç Verificar Campos da SprintHub</h1>
    
    <div class="container">
        <h2>1. Buscar Oportunidades do Lead</h2>
        <p>Lead ID: <input type="number" id="leadId" value="111184" style="padding: 5px; width: 100px;"></p>
        <button onclick="buscarOportunidades()">Buscar Oportunidades do Lead</button>
        <div id="resultOportunidades"></div>
    </div>

    <div class="container">
        <h2>2. Buscar Oportunidades dos Funis 6 e 14</h2>
        <p>Buscar oportunidades existentes para ver a estrutura real dos campos</p>
        <button onclick="buscarOportunidadesFunil6()">Buscar Funil 6 (Comercial)</button>
        <button onclick="buscarOportunidadesFunil14()">Buscar Funil 14 (Recompra)</button>
        <div id="resultFunil"></div>
    </div>

    <div class="container">
        <h2>3. Buscar Oportunidade Espec√≠fica</h2>
        <p>
            Opportunity ID: <input type="number" id="oppId" value="" style="padding: 5px; width: 100px;">
            Funil ID: <input type="number" id="funnelId" value="6" style="padding: 5px; width: 100px;">
        </p>
        <button onclick="buscarOportunidade()">Buscar Oportunidade</button>
        <div id="resultOportunidade"></div>
    </div>

    <div class="container">
        <h2>4. Testar Cria√ß√£o de Oportunidade</h2>
        <button onclick="testarCriacao()">Testar Cria√ß√£o (com campos atuais)</button>
        <div id="resultCriacao"></div>
    </div>

    <script>
        const CONFIG = {
            baseUrl: 'sprinthub-api-master.sprinthub.app',
            apiToken: '9ad36c85-5858-4960-9935-e73c3698dd0c',
            instance: 'oficialmed'
        };

        function buildUrl(path, query = {}) {
            const base = `https://${CONFIG.baseUrl}${path.startsWith('/') ? path : `/${path}`}`;
            const params = new URLSearchParams({
                apitoken: CONFIG.apiToken,
                i: CONFIG.instance,
                ...query
            });
            return `${base}?${params.toString()}`;
        }

        async function buscarOportunidades() {
            const leadId = document.getElementById('leadId').value;
            const resultDiv = document.getElementById('resultOportunidades');
            resultDiv.innerHTML = '<p class="info">Buscando...</p>';

            try {
                const url = buildUrl(`/listopportunitysleadcomplete/${leadId}`);
                console.log('URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${JSON.stringify(data)}`);
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ ${Array.isArray(data) ? data.length : 0} oportunidade(s) encontrada(s)</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

                // Se houver oportunidades, preencher o ID da primeira
                if (Array.isArray(data) && data.length > 0) {
                    document.getElementById('oppId').value = data[0].id;
                    if (data[0].funnel_id) {
                        document.getElementById('funnelId').value = data[0].funnel_id;
                    }
                    
                    // Mostrar estrutura dos fields
                    const fields = data[0].fields || {};
                    console.log('üìã Campos customizados (fields) encontrados:', Object.keys(fields));
                    console.log('üìã Estrutura completa:', data[0]);
                }

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
                console.error('Erro:', error);
            }
        }

        async function buscarOportunidadesFunil6() {
            const resultDiv = document.getElementById('resultFunil');
            resultDiv.innerHTML = '<p class="info">Buscando oportunidades do Funil 6...</p>';

            try {
                // Buscar oportunidades do funil 6 (coluna 232 - CADASTRO)
                const url = buildUrl('/crm/opportunities/6');
                console.log('URL Funil 6:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page: 0,
                        limit: 3,
                        columnId: 232
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${JSON.stringify(data)}`);
                }

                const opportunities = Array.isArray(data) ? data : (data.data || []);
                
                if (opportunities.length === 0) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Nenhuma oportunidade encontrada no Funil 6</p>';
                    return;
                }

                const opp = opportunities[0];
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ ${opportunities.length} oportunidade(s) encontrada(s) no Funil 6</p>
                    <h3>üìã Primeira Oportunidade (amostra):</h3>
                    <p><strong>ID:</strong> ${opp.id} | <strong>T√≠tulo:</strong> ${opp.title}</p>
                    <h3>üîç Campos customizados (fields):</h3>
                    <pre>${JSON.stringify(opp.fields || {}, null, 2)}</pre>
                    <h3>üìã Chaves dos fields:</h3>
                    <pre>${JSON.stringify(opp.fields ? Object.keys(opp.fields) : [], null, 2)}</pre>
                    <h3>üìÑ Estrutura completa (primeiros campos):</h3>
                    <pre>${JSON.stringify({
                        id: opp.id,
                        title: opp.title,
                        value: opp.value,
                        crm_column: opp.crm_column,
                        lead_id: opp.lead_id,
                        status: opp.status,
                        sequence: opp.sequence,
                        user: opp.user,
                        fields: opp.fields
                    }, null, 2)}</pre>
                `;

                // Preencher campos para teste
                if (opp.id) {
                    document.getElementById('oppId').value = opp.id;
                    document.getElementById('funnelId').value = 6;
                }

                console.log('üìã Funil 6 - Campos customizados:', opp.fields ? Object.keys(opp.fields) : []);
                console.log('üìã Funil 6 - Estrutura completa:', opp);

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
                console.error('Erro:', error);
            }
        }

        async function buscarOportunidadesFunil14() {
            const resultDiv = document.getElementById('resultFunil');
            resultDiv.innerHTML = '<p class="info">Buscando oportunidades do Funil 14...</p>';

            try {
                // Buscar oportunidades do funil 14 (coluna 227 - ENTRADA)
                const url = buildUrl('/crm/opportunities/14');
                console.log('URL Funil 14:', url);
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        page: 0,
                        limit: 3,
                        columnId: 227
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${JSON.stringify(data)}`);
                }

                const opportunities = Array.isArray(data) ? data : (data.data || []);
                
                if (opportunities.length === 0) {
                    resultDiv.innerHTML = '<p class="error">‚ùå Nenhuma oportunidade encontrada no Funil 14</p>';
                    return;
                }

                const opp = opportunities[0];
                resultDiv.innerHTML = `
                    <p class="success">‚úÖ ${opportunities.length} oportunidade(s) encontrada(s) no Funil 14</p>
                    <h3>üìã Primeira Oportunidade (amostra):</h3>
                    <p><strong>ID:</strong> ${opp.id} | <strong>T√≠tulo:</strong> ${opp.title}</p>
                    <h3>üîç Campos customizados (fields):</h3>
                    <pre>${JSON.stringify(opp.fields || {}, null, 2)}</pre>
                    <h3>üìã Chaves dos fields:</h3>
                    <pre>${JSON.stringify(opp.fields ? Object.keys(opp.fields) : [], null, 2)}</pre>
                    <h3>üìÑ Estrutura completa (primeiros campos):</h3>
                    <pre>${JSON.stringify({
                        id: opp.id,
                        title: opp.title,
                        value: opp.value,
                        crm_column: opp.crm_column,
                        lead_id: opp.lead_id,
                        status: opp.status,
                        sequence: opp.sequence,
                        user: opp.user,
                        fields: opp.fields
                    }, null, 2)}</pre>
                `;

                // Preencher campos para teste
                if (opp.id) {
                    document.getElementById('oppId').value = opp.id;
                    document.getElementById('funnelId').value = 14;
                }

                console.log('üìã Funil 14 - Campos customizados:', opp.fields ? Object.keys(opp.fields) : []);
                console.log('üìã Funil 14 - Estrutura completa:', opp);

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
                console.error('Erro:', error);
            }
        }

        async function buscarOportunidade() {
            const oppId = document.getElementById('oppId').value;
            const funnelId = document.getElementById('funnelId').value;
            const resultDiv = document.getElementById('resultOportunidade');
            resultDiv.innerHTML = '<p class="info">Buscando...</p>';

            if (!oppId || !funnelId) {
                resultDiv.innerHTML = '<p class="error">‚ùå Preencha o Opportunity ID e Funil ID</p>';
                return;
            }

            try {
                const url = buildUrl(`/crmopportunity/${oppId}`, { id: funnelId });
                console.log('URL:', url);
                
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${JSON.stringify(data)}`);
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Oportunidade encontrada!</p>
                    <h3>üìã Campos principais:</h3>
                    <pre>${JSON.stringify({
                        id: data.id,
                        title: data.title,
                        value: data.value,
                        crm_column: data.crm_column,
                        lead_id: data.lead_id,
                        status: data.status,
                        sequence: data.sequence,
                        user: data.user
                    }, null, 2)}</pre>
                    <h3>üîç Campos customizados (fields):</h3>
                    <pre>${JSON.stringify(data.fields || {}, null, 2)}</pre>
                    <h3>üìÑ Estrutura completa:</h3>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

                // Log no console
                console.log('üìã Estrutura completa da oportunidade:', data);
                console.log('üîç Campos customizados (fields):', data.fields || {});
                console.log('üìã Chaves dos fields:', data.fields ? Object.keys(data.fields) : []);

            } catch (error) {
                resultDiv.innerHTML = `<p class="error">‚ùå Erro: ${error.message}</p>`;
                console.error('Erro:', error);
            }
        }

        async function testarCriacao() {
            const leadId = document.getElementById('leadId').value;
            const funnelId = document.getElementById('funnelId').value;
            const resultDiv = document.getElementById('resultCriacao');
            resultDiv.innerHTML = '<p class="info">Testando cria√ß√£o...</p>';

            if (!leadId || !funnelId) {
                resultDiv.innerHTML = '<p class="error">‚ùå Preencha o Lead ID e Funil ID</p>';
                return;
            }

            // Determinar coluna baseada no funil
            let crmColumn = 286; // padr√£o
            if (funnelId == 6) {
                crmColumn = 232; // CADASTRO do funil 6
            } else if (funnelId == 14) {
                crmColumn = 227; // ENTRADA do funil 14
            }

            // Payload que estamos tentando enviar
            const payload = {
                title: "Teste | Verificar Campos",
                value: 0,
                crm_column: crmColumn,
                lead_id: parseInt(leadId),
                status: "open",
                fields: {
                    ultimo_pedido: "Teste de pedido",
                    ultimo_orcamento: "Teste de or√ßamento",
                    verifique: "Teste verifique",
                    codigo_referencia: "TEST123",
                    id_prime: "123456"
                }
            };

            try {
                const url = buildUrl('/crmopportunity', { id: funnelId });
                console.log('URL:', url);
                console.log('Payload:', JSON.stringify(payload, null, 2));
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(`Erro ${response.status}: ${JSON.stringify(data)}`);
                }

                resultDiv.innerHTML = `
                    <p class="success">‚úÖ Oportunidade criada com sucesso!</p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;

            } catch (error) {
                resultDiv.innerHTML = `
                    <p class="error">‚ùå Erro ao criar: ${error.message}</p>
                    <pre>${error.message}</pre>
                `;
                console.error('Erro completo:', error);
            }
        }
    </script>
</body>
</html>

