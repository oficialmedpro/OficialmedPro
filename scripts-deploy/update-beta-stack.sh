#!/bin/bash

# ğŸš€ Script para Atualizar a Stack Beta no Servidor
# Execute este script no servidor manager do Docker Swarm

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘     Atualizar Stack Beta - Oficial Med               â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Cores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Verificar se estÃ¡ no manager node
echo -e "${YELLOW}ğŸ” Verificando se estÃ¡ no manager node...${NC}"
if ! docker info | grep -q "Is Manager: true"; then
    echo -e "${RED}âŒ Este script deve ser executado no manager node do Docker Swarm${NC}"
    exit 1
fi
echo -e "${GREEN}âœ… Manager node detectado${NC}"

# Verificar se a stack existe
STACK_NAME="beta"
echo -e "${YELLOW}ğŸ” Verificando se a stack '$STACK_NAME' existe...${NC}"

if ! docker stack ls | grep -q "$STACK_NAME"; then
    echo -e "${YELLOW}âš ï¸  Stack '$STACK_NAME' nÃ£o encontrada.${NC}"
    echo -e "${YELLOW}   Tentando encontrar stacks relacionadas ao beta...${NC}"
    docker stack ls | grep -i beta || echo "   Nenhuma stack beta encontrada"
    echo ""
    read -p "Deseja criar uma nova stack? (s/n) " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Ss]$ ]]; then
        STACK_FILE="stacks/stack-beta-oficialmed-correto.yml"
        if [ ! -f "$STACK_FILE" ]; then
            echo -e "${RED}âŒ Arquivo $STACK_FILE nÃ£o encontrado!${NC}"
            exit 1
        fi
        echo -e "${YELLOW}ğŸ“¦ Criando nova stack '$STACK_NAME'...${NC}"
        docker stack deploy -c "$STACK_FILE" "$STACK_NAME" --with-registry-auth
        echo -e "${GREEN}âœ… Stack criada com sucesso!${NC}"
        exit 0
    else
        echo -e "${YELLOW}âŒ OperaÃ§Ã£o cancelada${NC}"
        exit 0
    fi
fi

echo -e "${GREEN}âœ… Stack '$STACK_NAME' encontrada${NC}"

# Nome da imagem
IMAGE_NAME="oficialmedpro/oficialmed-pwa:latest"

echo ""
echo -e "${CYAN}ğŸ“¦ InformaÃ§Ãµes da AtualizaÃ§Ã£o:${NC}"
echo -e "   Stack: ${CYAN}$STACK_NAME${NC}"
echo -e "   Imagem: ${CYAN}$IMAGE_NAME${NC}"
echo ""

# Confirmar antes de continuar
read -p "Deseja continuar com a atualizaÃ§Ã£o? (s/n) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Ss]$ ]]; then
    echo -e "${YELLOW}âŒ AtualizaÃ§Ã£o cancelada${NC}"
    exit 0
fi

# Fazer pull da nova imagem
echo ""
echo -e "${YELLOW}ğŸ“¥ Fazendo pull da nova imagem...${NC}"
docker pull "$IMAGE_NAME"

if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Erro ao fazer pull da imagem!${NC}"
    exit 1
fi

echo -e "${GREEN}âœ… Imagem atualizada localmente${NC}"

# Atualizar o serviÃ§o
echo ""
echo -e "${YELLOW}ğŸ”„ Atualizando serviÃ§os da stack...${NC}"

# Encontrar o nome do serviÃ§o beta
SERVICE_NAME=$(docker service ls --filter "label=com.docker.stack.namespace=$STACK_NAME" --format "{{.Name}}" | grep -i beta | head -n 1)

if [ -z "$SERVICE_NAME" ]; then
    echo -e "${YELLOW}âš ï¸  ServiÃ§o beta nÃ£o encontrado. Tentando atualizar a stack completa...${NC}"
    STACK_FILE="stacks/stack-beta-oficialmed-correto.yml"
    if [ -f "$STACK_FILE" ]; then
        docker stack deploy -c "$STACK_FILE" "$STACK_NAME" --with-registry-auth
        echo -e "${GREEN}âœ… Stack atualizada com sucesso!${NC}"
    else
        echo -e "${RED}âŒ Arquivo $STACK_FILE nÃ£o encontrado!${NC}"
        exit 1
    fi
else
    echo -e "${CYAN}   ServiÃ§o encontrado: $SERVICE_NAME${NC}"
    docker service update --image "$IMAGE_NAME" --force "$SERVICE_NAME"
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ Erro ao atualizar o serviÃ§o!${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}âœ… ServiÃ§o atualizado com sucesso!${NC}"
fi

# Aguardar alguns segundos
echo ""
echo -e "${YELLOW}â³ Aguardando estabilizaÃ§Ã£o...${NC}"
sleep 5

# Verificar status
echo ""
echo -e "${CYAN}ğŸ“Š Status dos serviÃ§os:${NC}"
docker service ls --filter "label=com.docker.stack.namespace=$STACK_NAME"

echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          AtualizaÃ§Ã£o ConcluÃ­da!                      â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo -e "${GREEN}âœ… Stack Beta atualizada com sucesso!${NC}"
echo ""
echo -e "${CYAN}ğŸŒ URL do Beta:${NC}"
echo "   https://beta.oficialmed.com.br"
echo ""
echo -e "${CYAN}ğŸ“‹ Para verificar os logs:${NC}"
echo "   docker service logs -f $SERVICE_NAME"
echo ""

