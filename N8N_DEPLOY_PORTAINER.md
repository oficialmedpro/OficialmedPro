# Deploy N8N via Portainer - Passo a Passo üöÄ

## Guia Completo para Deploy do N8N usando Interface do Portainer

---

## üìã Pr√©-requisitos

Antes de come√ßar, certifique-se de que voc√™ tem:
- ‚úÖ Portainer instalado e acess√≠vel
- ‚úÖ Docker Swarm ativo
- ‚úÖ PostgreSQL rodando (mesma stack do Typebot)
- ‚úÖ Traefik configurado
- ‚úÖ Rede `OficialMed` criada
- ‚úÖ DNS configurado para:
  - `workflows.oficialmed.com.br`
  - `webhook.oficialmed.com.br`

---

## üóÑÔ∏è PASSO 1: Criar o Banco de Dados N8N

### 1.1 - Acessar o Container do PostgreSQL

1. Acesse o **Portainer**
2. No menu lateral, clique em **"Containers"**
3. Localize o container do **PostgreSQL** (geralmente `postgres` ou similar)
4. Clique no nome do container

### 1.2 - Abrir Console do PostgreSQL

1. Na p√°gina do container, clique em **"Console"** (√≠cone de terminal >_)
2. Selecione **"/bin/bash"** ou **"/bin/sh"** no dropdown
3. Clique em **"Connect"**

### 1.3 - Criar o Banco de Dados

No terminal que abriu, digite os seguintes comandos:

```bash
# Conectar ao PostgreSQL
psql -U postgres

# Criar o banco de dados n8n
CREATE DATABASE n8n WITH ENCODING = 'UTF8';

# Verificar se foi criado
\l

# Sair do psql
\q

# Sair do bash
exit
```

**‚úÖ Pronto!** O banco de dados `n8n` foi criado.

---

## üê≥ PASSO 2: Adicionar a Stack do N8N no Portainer

### 2.1 - Acessar Stacks

1. No menu lateral do Portainer, clique em **"Stacks"**
2. Clique no bot√£o **"+ Add stack"**

### 2.2 - Configurar a Stack

1. **Name**: Digite `n8n` (ou `n8n-oficialmed`)

2. **Build method**: Selecione **"Web editor"**

3. **Web editor**: Cole o conte√∫do abaixo:

```yaml
version: "3.7"
services:

## --------------------------- N8N --------------------------- ##

  n8n:
    image: n8nio/n8n:latest
    
    networks:
      - OficialMed
    
    environment:
    ## üóÑÔ∏è Dados do Postgres
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=postgres
      - DB_POSTGRESDB_PASSWORD=a5895d0e44e68fc82c13e7d6a92313dd
    
    ## üîê Encryption key (NUNCA altere ap√≥s primeiro deploy!)
      - N8N_ENCRYPTION_KEY=83d8442f4011a5908b9bc882520d3352a1b2c3d4e5f6g7h8
    
    ## üåê URLs do n8n
      - N8N_HOST=workflows.oficialmed.com.br
      - N8N_PROTOCOL=https
      - N8N_PORT=5678
      - WEBHOOK_URL=https://webhook.oficialmed.com.br/
    
    ## üë§ Credenciais do Admin (ALTERE a senha!)
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=admin
      - N8N_BASIC_AUTH_PASSWORD=OfiCialMed2025!
    
    ## üìß Dados do SMTP
      - N8N_EMAIL_MODE=smtp
      - N8N_SMTP_HOST=smtp.gmail.com
      - N8N_SMTP_PORT=465
      - N8N_SMTP_USER=mkt.oficialmed@gmail.com
      - N8N_SMTP_PASS=Joao1633@@
      - N8N_SMTP_SENDER=mkt.oficialmed@gmail.com
      - N8N_SMTP_SSL=true
    
    ## üóÉÔ∏è Configura√ß√µes gerais
      - N8N_DIAGNOSTICS_ENABLED=false
      - N8N_PERSONALIZATION_ENABLED=true
      - N8N_VERSION_NOTIFICATIONS_ENABLED=true
      - N8N_TEMPLATES_ENABLED=true
      - N8N_LOG_LEVEL=info
      - N8N_LOG_OUTPUT=console
    
    ## üìÇ Configura√ß√µes de execu√ß√£o
      - EXECUTIONS_DATA_SAVE_ON_ERROR=all
      - EXECUTIONS_DATA_SAVE_ON_SUCCESS=all
      - EXECUTIONS_DATA_SAVE_MANUAL_EXECUTIONS=true
      - EXECUTIONS_DATA_PRUNE=true
      - EXECUTIONS_DATA_MAX_AGE=336
    
    ## ‚è±Ô∏è Timezone
      - GENERIC_TIMEZONE=America/Sao_Paulo
      - TZ=America/Sao_Paulo
    
    volumes:
      - n8n_data:/home/node/.n8n
    
    deploy:
      mode: replicated
      replicas: 1
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          cpus: "2"
          memory: 2048M
      labels:
        - io.portainer.accesscontrol.users=admin
        
        ## workflows.oficialmed.com.br (interface principal)
        - traefik.enable=true
        - traefik.http.routers.n8n_editor.rule=Host(`workflows.oficialmed.com.br`)
        - traefik.http.routers.n8n_editor.entrypoints=websecure
        - traefik.http.routers.n8n_editor.tls.certresolver=letsencryptresolver
        - traefik.http.services.n8n_editor.loadbalancer.server.port=5678
        - traefik.http.services.n8n_editor.loadbalancer.passHostHeader=true
        - traefik.http.routers.n8n_editor.service=n8n_editor
        
        ## webhook.oficialmed.com.br (webhooks)
        - traefik.http.routers.n8n_webhook.rule=Host(`webhook.oficialmed.com.br`)
        - traefik.http.routers.n8n_webhook.entrypoints=websecure
        - traefik.http.routers.n8n_webhook.tls.certresolver=letsencryptresolver
        - traefik.http.routers.n8n_webhook.service=n8n_webhook
        - traefik.http.services.n8n_webhook.loadbalancer.server.port=5678

## --------------------------- VOLUMES --------------------------- ##

volumes:
  n8n_data:
    driver: local

## --------------------------- NETWORKS --------------------------- ##

networks:
  OficialMed:
    external: true
    name: OficialMed
```

### 2.3 - Deploy da Stack

1. **N√£o marque** nenhuma op√ß√£o adicional (a menos que voc√™ saiba o que est√° fazendo)
2. Role at√© o final da p√°gina
3. Clique no bot√£o **"Deploy the stack"**

### 2.4 - Aguardar Deploy

- O Portainer vai mostrar uma mensagem de sucesso
- Voc√™ ser√° redirecionado para a lista de stacks
- Aguarde **2-3 minutos** para o N8N inicializar completamente

---

## üîç PASSO 3: Verificar se est√° Funcionando

### 3.1 - Verificar a Stack

1. Em **"Stacks"**, voc√™ deve ver a stack **"n8n"** com status **"active"**
2. Clique no nome da stack **"n8n"**
3. Voc√™ ver√° o servi√ßo **"n8n_n8n"** listado

### 3.2 - Verificar o Servi√ßo

1. Clique em **"Services"** no menu lateral
2. Localize **"n8n_n8n"**
3. Verifique se est√° **"1/1"** (significa que 1 r√©plica de 1 est√° rodando)
4. Clique no servi√ßo para ver mais detalhes

### 3.3 - Ver os Logs

1. Na p√°gina do servi√ßo, clique em **"Service logs"**
2. Voc√™ deve ver logs como:
   ```
   n8n ready on 0.0.0.0, port 5678
   Version: X.XX.X
   Editor is now accessible via:
   http://localhost:5678/
   ```

3. Se houver erros, leia os logs para identificar o problema

---

## üåê PASSO 4: Acessar o N8N

### 4.1 - Primeiro Acesso

1. Abra o navegador
2. Acesse: **https://workflows.oficialmed.com.br**
3. Voc√™ ver√° uma tela de login (autentica√ß√£o b√°sica)

### 4.2 - Fazer Login

```
Usu√°rio: admin
Senha: OfiCialMed2025!
```

### 4.3 - ‚ö†Ô∏è IMPORTANTE: Alterar a Senha

1. Ap√≥s fazer login, v√° em **Settings** (√≠cone de engrenagem)
2. Clique em **"Users"**
3. Clique no seu usu√°rio
4. Altere a senha padr√£o para uma senha forte

---

## ‚úÖ PASSO 5: Testar Funcionalidades

### 5.1 - Criar Workflow de Teste

1. Na interface do N8N, clique em **"+ New"** ou **"Create Workflow"**
2. Adicione um n√≥ **"Schedule Trigger"** (arrastar da barra lateral)
3. Adicione um n√≥ **"Set"** ou **"Code"**
4. Conecte os n√≥s
5. Clique em **"Execute Workflow"**
6. Verifique se funcionou ‚úÖ

### 5.2 - Testar Webhook

1. Crie um novo workflow
2. Adicione um n√≥ **"Webhook"**
3. Configure:
   - HTTP Method: **POST**
   - Path: **test**
4. Clique em **"Listen for Test Event"**
5. A URL do webhook ser√° algo como:
   ```
   https://webhook.oficialmed.com.br/webhook-test/test
   ```
6. Teste com curl (em outro terminal):
   ```bash
   curl -X POST https://webhook.oficialmed.com.br/webhook-test/test \
     -H "Content-Type: application/json" \
     -d '{"teste": "funcionou"}'
   ```

---

## üîß PASSO 6: Configura√ß√µes Adicionais (Opcional)

### 6.1 - Ajustar Recursos

Se precisar de mais recursos:

1. V√° em **"Stacks"** ‚Üí **"n8n"**
2. Clique em **"Editor"**
3. Modifique as linhas:
   ```yaml
   resources:
     limits:
       cpus: "4"        # Aumentar CPUs
       memory: 4096M    # Aumentar mem√≥ria
   ```
4. Clique em **"Update the stack"**

### 6.2 - Desabilitar Autentica√ß√£o B√°sica (ap√≥s configurar OAuth)

1. Edite a stack
2. Comente ou remova estas linhas:
   ```yaml
   # - N8N_BASIC_AUTH_ACTIVE=true
   # - N8N_BASIC_AUTH_USER=admin
   # - N8N_BASIC_AUTH_PASSWORD=OfiCialMed2025!
   ```
3. Atualize a stack

---

## üõ†Ô∏è Troubleshooting pelo Portainer

### Problema: Stack n√£o inicia

1. **Verificar logs**:
   - Stacks ‚Üí n8n ‚Üí Service logs
   - Procure por mensagens de erro em vermelho

2. **Verificar o banco de dados**:
   - Containers ‚Üí postgres ‚Üí Console
   - Execute: `psql -U postgres -l | grep n8n`
   - Deve mostrar o banco `n8n`

3. **Verificar a rede**:
   - Networks ‚Üí Procure `OficialMed`
   - Deve estar listada e ativa

### Problema: N√£o consigo acessar a URL

1. **Verificar DNS**:
   - Abra o terminal do seu computador
   - Execute: `nslookup workflows.oficialmed.com.br`
   - Deve retornar o IP do seu servidor

2. **Verificar Traefik**:
   - Services ‚Üí traefik ‚Üí Service logs
   - Procure por men√ß√µes ao dom√≠nio

3. **Verificar certificado SSL**:
   - Aguarde 2-3 minutos para o Let's Encrypt emitir
   - Acesse: `http://workflows.oficialmed.com.br` (sem HTTPS)
   - Deve redirecionar para HTTPS

### Problema: Erro de conex√£o com banco

1. **Verificar senha**:
   - A senha no YAML deve ser exatamente a mesma do PostgreSQL
   - Verifique em: Stacks ‚Üí (stack do Typebot) ‚Üí Editor
   - Compare a senha do PostgreSQL

2. **Testar conex√£o**:
   - Containers ‚Üí n8n ‚Üí Console ‚Üí Connect
   - Execute: `ping postgres`
   - Deve responder (Ctrl+C para parar)

---

## üìä Monitoramento pelo Portainer

### Verificar Status em Tempo Real

1. **Dashboard**:
   - Home ‚Üí Mostra vis√£o geral do cluster

2. **Service Details**:
   - Services ‚Üí n8n_n8n ‚Üí Mostra r√©plicas, tarefas, logs

3. **Resources**:
   - Services ‚Üí n8n_n8n ‚Üí Aba "Stats"
   - Mostra uso de CPU e mem√≥ria em tempo real

### Logs

1. **Service Logs**:
   - Services ‚Üí n8n_n8n ‚Üí Service logs
   - Marque **"Auto-refresh logs"** para atualiza√ß√£o autom√°tica

2. **Filtrar Logs**:
   - Use a busca (Ctrl+F) para procurar erros
   - Procure por: `ERROR`, `WARN`, `Failed`

---

## üíæ Backup pelo Portainer

### Backup do Volume

1. **Via Console**:
   - Containers ‚Üí postgres ‚Üí Console ‚Üí Connect
   - Execute:
     ```bash
     pg_dump -U postgres n8n > /tmp/n8n-backup.sql
     ```

2. **Baixar o arquivo**:
   - Voc√™ pode usar SCP ou SFTP para baixar de `/tmp/n8n-backup.sql`

### Backup da Stack (configura√ß√£o)

1. Stacks ‚Üí n8n ‚Üí **"Editor"**
2. Copie **TODO o conte√∫do** do YAML
3. Cole em um arquivo de texto no seu computador
4. Salve como: `n8n-stack-backup-YYYYMMDD.yml`

---

## üìù Checklist Final

Ap√≥s completar todos os passos, verifique:

- [ ] Stack "n8n" est√° com status "active" no Portainer
- [ ] Servi√ßo "n8n_n8n" est√° com r√©plicas "1/1"
- [ ] Logs n√£o mostram erros cr√≠ticos
- [ ] Acesso a https://workflows.oficialmed.com.br funciona
- [ ] Login com credenciais padr√£o funciona
- [ ] Senha foi alterada
- [ ] Workflow de teste foi criado e executado com sucesso
- [ ] Webhook foi testado e funciona
- [ ] Backup da configura√ß√£o foi salvo

---

## üéØ Pr√≥ximos Passos

1. **Criar seus workflows**:
   - Explore os templates do N8N
   - Crie workflows personalizados

2. **Integrar com Typebot**:
   - Use webhooks do N8N no Typebot
   - Automatize processos

3. **Configurar backup autom√°tico**:
   - Agende backups regulares
   - Teste o restore

4. **Documentar workflows**:
   - Adicione descri√ß√µes nos workflows
   - Documente integra√ß√µes

---

## üìö Links √öteis

- üìñ [Documenta√ß√£o N8N](https://docs.n8n.io/)
- üí¨ [Comunidade N8N](https://community.n8n.io/)
- üé® [Templates](https://n8n.io/workflows/)
- üìñ [Documenta√ß√£o Portainer](https://docs.portainer.io/)

---

## üÜò Suporte

Se tiver problemas:

1. **Verifique os logs** no Portainer
2. **Consulte** este guia e os outros arquivos de documenta√ß√£o
3. **Procure** na comunidade N8N
4. **Revise** as configura√ß√µes passo a passo

---

**Guia criado para Oficial Med** | Outubro 2025  
**Vers√£o**: 1.0  

‚úÖ **Deploy via Portainer - 100% Interface Gr√°fica**

