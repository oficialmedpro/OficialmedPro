<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Credenciais Google Ads</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .results {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        pre {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .test-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <h1>üß™ Teste de Credenciais Google Ads</h1>
    <p>Este teste verifica se conseguimos acessar as credenciais do Google Ads armazenadas no Supabase.</p>
    
    <button class="test-button" onclick="testarCredenciais()" id="testBtn">
        üöÄ Testar Credenciais
    </button>
    
    <button class="test-button" onclick="testarConexao()" id="connectionBtn">
        üîó Testar Conex√£o Completa
    </button>

    <div id="results" class="results" style="display: none;">
        <h2>Resultados:</h2>
        <div id="content"></div>
    </div>

    <script>
        // Configura√ß√µes (mesmas do .env)
        const config = {
            supabaseUrl: 'https://agdffspstbxeqhqtltvb.supabase.co',
            supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFnZGZmc3BzdGJ4ZXFocXRsdHZiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1MDQ1MzY2NiwiZXhwIjoyMDY2MDI5NjY2fQ.grInwGHFAH2WYvYerwfHkUsM08wXCJASg4CPMD2cTaA',
            schema: 'api'
        };

        function showResults(content, isError = false) {
            const resultsDiv = document.getElementById('results');
            const contentDiv = document.getElementById('content');
            
            resultsDiv.style.display = 'block';
            contentDiv.innerHTML = content;
            contentDiv.className = isError ? 'error' : 'success';
        }

        async function testarCredenciais() {
            const testBtn = document.getElementById('testBtn');
            testBtn.disabled = true;
            testBtn.textContent = '‚è≥ Testando...';

            try {
                console.log('üîç Buscando credenciais do Google Ads...');
                
                const response = await fetch(`${config.supabaseUrl}/rest/v1/unidades?select=id,unidade,codigo_sprint,google_customer_id,google_developer_token,google_client_id,google_client_secret,google_refresh_token,google_ads_active&codigo_sprint=eq.[1]`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${config.supabaseKey}`,
                        'apikey': config.supabaseKey,
                        'Accept-Profile': config.schema,
                        'Content-Profile': config.schema
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();

                if (!data || data.length === 0) {
                    throw new Error('Nenhuma unidade encontrada com c√≥digo_sprint="[1]"');
                }

                const unidade = data[0];
                
                const resultHtml = `
                    <h3>‚úÖ Credenciais encontradas para: ${unidade.unidade}</h3>
                    <ul>
                        <li><strong>Customer ID:</strong> ${unidade.google_customer_id || '‚ùå N√£o configurado'}</li>
                        <li><strong>Developer Token:</strong> ${unidade.google_developer_token ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}</li>
                        <li><strong>Client ID:</strong> ${unidade.google_client_id ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}</li>
                        <li><strong>Client Secret:</strong> ${unidade.google_client_secret ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}</li>
                        <li><strong>Refresh Token:</strong> ${unidade.google_refresh_token ? '‚úÖ Configurado' : '‚ùå N√£o configurado'}</li>
                        <li><strong>Google Ads Ativo:</strong> ${unidade.google_ads_active ? '‚úÖ Ativo' : '‚ùå Inativo'}</li>
                    </ul>
                    <h4>Dados Brutos:</h4>
                    <pre>${JSON.stringify(unidade, null, 2)}</pre>
                `;

                showResults(resultHtml, false);

            } catch (error) {
                console.error('‚ùå Erro:', error);
                showResults(`<h3>‚ùå Erro ao buscar credenciais:</h3><p>${error.message}</p>`, true);
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = 'üöÄ Testar Credenciais';
            }
        }

        async function testarConexao() {
            const connectionBtn = document.getElementById('connectionBtn');
            connectionBtn.disabled = true;
            connectionBtn.textContent = '‚è≥ Testando conex√£o...';

            try {
                // Primeiro buscar as credenciais
                const response = await fetch(`${config.supabaseUrl}/rest/v1/unidades?select=*&codigo_sprint=eq.[1]`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Authorization': `Bearer ${config.supabaseKey}`,
                        'apikey': config.supabaseKey,
                        'Accept-Profile': config.schema,
                        'Content-Profile': config.schema
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                if (!data || data.length === 0) {
                    throw new Error('Unidade n√£o encontrada');
                }

                const unidade = data[0];
                const credentials = {
                    customerId: unidade.google_customer_id,
                    developerToken: unidade.google_developer_token,
                    clientId: unidade.google_client_id,
                    clientSecret: unidade.google_client_secret,
                    refreshToken: unidade.google_refresh_token,
                    isActive: unidade.google_ads_active
                };

                // Validar credenciais
                const missing = [];
                if (!credentials.customerId) missing.push('Customer ID');
                if (!credentials.developerToken) missing.push('Developer Token');
                if (!credentials.clientId) missing.push('Client ID');
                if (!credentials.clientSecret) missing.push('Client Secret');
                if (!credentials.refreshToken) missing.push('Refresh Token');

                let resultHtml = `<h3>üîç Teste de Conex√£o Completo</h3>`;
                
                if (missing.length > 0) {
                    resultHtml += `<h4>‚ùå Credenciais faltando:</h4><ul>`;
                    missing.forEach(item => {
                        resultHtml += `<li>${item}</li>`;
                    });
                    resultHtml += `</ul>`;
                }

                if (!credentials.isActive) {
                    resultHtml += `<h4>‚ö†Ô∏è Google Ads n√£o est√° ativo para esta unidade</h4>`;
                }

                // Validar formato do Customer ID
                const customerIdValid = credentials.customerId && /^\d{10}$/.test(credentials.customerId.replace(/-/g, ''));
                
                resultHtml += `<h4>üìä Status das Valida√ß√µes:</h4><ul>`;
                resultHtml += `<li>Credenciais completas: ${missing.length === 0 ? '‚úÖ' : '‚ùå'}</li>`;
                resultHtml += `<li>Google Ads ativo: ${credentials.isActive ? '‚úÖ' : '‚ùå'}</li>`;
                resultHtml += `<li>Customer ID v√°lido: ${customerIdValid ? '‚úÖ' : '‚ùå'}</li>`;
                resultHtml += `</ul>`;

                if (missing.length === 0 && credentials.isActive && customerIdValid) {
                    resultHtml += `<h4>üéâ Resultado: Credenciais prontas para uso!</h4>`;
                    resultHtml += `<p>As credenciais est√£o completas e v√°lidas. Pr√≥ximo passo seria implementar um servidor backend para fazer chamadas seguras √† API do Google Ads.</p>`;
                } else {
                    resultHtml += `<h4>‚ö†Ô∏è Resultado: Credenciais precisam ser configuradas</h4>`;
                }

                resultHtml += `<h4>üîß Dados T√©cnicos:</h4>`;
                resultHtml += `<pre>${JSON.stringify({
                    unidade: unidade.unidade,
                    credentials: {
                        hasCustomerId: !!credentials.customerId,
                        hasDeveloperToken: !!credentials.developerToken,
                        hasClientId: !!credentials.clientId,
                        hasClientSecret: !!credentials.clientSecret,
                        hasRefreshToken: !!credentials.refreshToken,
                        isActive: credentials.isActive,
                        customerIdFormat: customerIdValid
                    }
                }, null, 2)}</pre>`;

                showResults(resultHtml, missing.length > 0);

            } catch (error) {
                console.error('‚ùå Erro na conex√£o:', error);
                showResults(`<h3>‚ùå Erro no teste de conex√£o:</h3><p>${error.message}</p>`, true);
            } finally {
                connectionBtn.disabled = false;
                connectionBtn.textContent = 'üîó Testar Conex√£o Completa';
            }
        }
    </script>
</body>
</html>