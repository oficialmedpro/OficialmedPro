<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard de Clientes e Pedidos - Prime</title>
  <style>
    :root {
      --bg: #f5f5f7;
      --surface: #fff;
      --text: #1d1d1f;
      --muted: #6e6e73;
      --border: #e6e6eb;
      --radius: 18px;
      --shadow: 0 8px 30px rgba(0,0,0,.06);
      --blue: #007aff;
      --green: #34c759;
      --orange: #ff9500;
      --red: #ff3b30;
      --purple: #af52de;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      flex-wrap: wrap;
      gap: 16px;
    }

    h1 {
      font-size: 28px;
      margin: 0;
      font-weight: 700;
    }

    .segmented {
      display: inline-grid;
      grid-auto-flow: column;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      box-shadow: var(--shadow);
    }

    .segmented label {
      padding: 12px 20px;
      cursor: pointer;
      color: var(--muted);
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .segmented input {
      display: none;
    }

    #tab-clientes:checked ~ header .segmented label[for=tab-clientes],
    #tab-pedidos:checked ~ header .segmented label[for=tab-pedidos] {
      background: #f2f2f7;
      color: var(--text);
    }

    .view {
      display: none;
    }

    #tab-clientes:checked ~ .views .view-clientes {
      display: block;
    }

    #tab-pedidos:checked ~ .views .view-pedidos {
      display: block;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: var(--shadow);
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-group label {
      font-weight: 600;
      color: var(--text);
      font-size: 14px;
    }

    .filter-group input,
    .filter-group select {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
    }

    .filter-group input:focus,
    .filter-group select:focus {
      outline: none;
      border-color: var(--blue);
      box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      padding-left: 40px;
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }

    .btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background: #f8f9fa;
    }

    .btn-primary {
      background: var(--blue);
      color: #fff;
      border: none;
    }

    .btn-primary:hover {
      background: #0056b3;
    }

    .btn-secondary {
      background: var(--green);
      color: #fff;
      border: none;
    }

    .btn-secondary:hover {
      background: #28a745;
    }

    .btn-danger {
      background: var(--red);
      color: #fff;
      border: none;
    }

    .btn-danger:hover {
      background: #dc3545;
    }

    .table-container {
      overflow-x: auto;
      border-radius: var(--radius);
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
      background: #fff;
    }

    thead th {
      background: #fafafa;
      border-bottom: 1px solid var(--border);
      text-align: left;
      padding: 16px 12px;
      color: var(--muted);
      font-weight: 600;
      position: sticky;
      top: 0;
    }

    .sortable {
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s ease;
    }

    .sortable:hover {
      background: #e8f4fd;
    }

    .sort-icon {
      font-size: 12px;
      margin-left: 4px;
      opacity: 0.6;
    }

    .sort-asc .sort-icon::after {
      content: " ‚Üë";
      color: var(--blue);
    }

    .sort-desc .sort-icon::after {
      content: " ‚Üì";
      color: var(--blue);
    }

    tbody td {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    tbody tr:hover {
      background: #fafafc;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .status-aprovado {
      background: #d4edda;
      color: #155724;
    }

    .status-nao-aprovado {
      background: #f8d7da;
      color: #721c24;
    }

    .status-aviado {
      background: #cce5ff;
      color: #004085;
    }

    .status-orcado {
      background: #fff3cd;
      color: #856404;
    }

    .status-entregue {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-cancelado {
      background: #f8d7da;
      color: #721c24;
    }

    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .pagination button:hover:not(:disabled) {
      background: #f8f9fa;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination .current {
      background: var(--blue);
      color: #fff;
      border-color: var(--blue);
    }

    .loading {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 40px;
      color: var(--muted);
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      padding: 12px;
      border-radius: 8px;
      margin: 20px 0;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--muted);
    }

    .empty-state h3 {
      margin: 0 0 8px 0;
      color: var(--text);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
    }

    .stat-card .value {
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 4px;
    }

    .stat-card .label {
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .client-details {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 16px;
      margin: 16px 0;
    }

    .client-details h3 {
      margin: 0 0 12px 0;
      color: var(--text);
    }

    .client-info {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
    }

    .client-info div {
      font-size: 14px;
    }

    .client-info strong {
      color: var(--text);
    }

    .client-info span {
      color: var(--muted);
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .client-info {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <input type="radio" id="tab-clientes" name="tabs" checked hidden>
    <input type="radio" id="tab-pedidos" name="tabs" hidden>
    
    <header>
      <h1>Dashboard Clientes e Pedidos</h1>
      <div class="segmented">
        <label for="tab-clientes">Clientes</label>
        <label for="tab-pedidos">Pedidos</label>
      </div>
    </header>

    <div class="views">
      <!-- View Clientes -->
      <section class="view view-clientes">
        <div class="card">
          <h2>Buscar Clientes</h2>
          <div class="filters">
            <div class="filter-group search-box">
              <label for="cliente-search-type">Tipo de Busca</label>
              <select id="cliente-search-type">
                <option value="todos">Todos os campos</option>
                <option value="nome">Nome</option>
                <option value="telefone">Telefone</option>
                <option value="req">REQ (Requisi√ß√£o)</option>
              </select>
            </div>
            <div class="filter-group search-box">
              <label for="cliente-search">Buscar</label>
              <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="cliente-search" placeholder="Digite o termo de busca...">
              </div>
            </div>
            <div class="filter-group">
              <label for="cliente-order">Ordenar por</label>
              <select id="cliente-order">
                <option value="nome">Nome</option>
                <option value="ultima_compra">√öltima Compra</option>
                <option value="total_orcamentos">Total de Or√ßamentos</option>
                <option value="valor_total_orcamentos">Valor Total</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="cliente-direction">Dire√ß√£o</label>
              <select id="cliente-direction">
                <option value="asc">Crescente</option>
                <option value="desc">Decrescente</option>
              </select>
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button class="btn btn-primary" onclick="buscarClientes()">
                üîç Buscar
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Ferramentas Avan√ßadas</h2>
          <div class="actions">
            <a href="/src/pages/matriz-rfv.html" class="btn btn-primary">
              üìä Matriz RFV
            </a>
            <a href="/src/pages/cidades-estados.html" class="btn btn-secondary">
              üó∫Ô∏è Cidades/Estados
            </a>
          </div>
        </div>

        <div class="card">
          <h2>Estat√≠sticas</h2>
          <div class="stats-grid" id="cliente-stats">
            <div class="loading">Carregando estat√≠sticas...</div>
          </div>
        </div>

        <div class="card">
          <h2>Lista de Clientes</h2>
          <div id="cliente-list">
            <div class="loading">Carregando clientes...</div>
          </div>
        </div>
      </section>

      <!-- View Pedidos -->
      <section class="view view-pedidos">
        <div class="card">
          <h2>Buscar Pedidos</h2>
          <div class="filters">
            <div class="filter-group search-box">
              <label for="pedido-search">Buscar por n√∫mero ou cliente</label>
              <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" id="pedido-search" placeholder="N√∫mero do pedido ou nome do cliente...">
              </div>
            </div>
            <div class="filter-group">
              <label for="pedido-status-geral">Status Geral</label>
              <select id="pedido-status-geral">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="pedido-status-aprovacao">Status Aprova√ß√£o</label>
              <select id="pedido-status-aprovacao">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="pedido-status-entrega">Status Entrega</label>
              <select id="pedido-status-entrega">
                <option value="">Todos</option>
              </select>
            </div>
            <div class="filter-group">
              <label for="pedido-data-inicio">Data In√≠cio</label>
              <input type="date" id="pedido-data-inicio">
            </div>
            <div class="filter-group">
              <label for="pedido-data-fim">Data Fim</label>
              <input type="date" id="pedido-data-fim">
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button class="btn btn-primary" onclick="buscarPedidos()">
                üîç Buscar
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <h2>Estat√≠sticas</h2>
          <div class="stats-grid" id="pedido-stats">
            <div class="loading">Carregando estat√≠sticas...</div>
          </div>
        </div>

        <div class="card">
          <h2>Lista de Pedidos</h2>
          <div id="pedido-list">
            <div class="loading">Carregando pedidos...</div>
          </div>
        </div>
      </section>
    </div>
  </div>

  <script type="module">
    import { primeClientesService } from '../service/primeClientesService.js';
    import { primePedidosService } from '../service/primePedidosService.js';

    // Estado global
    let currentClientePage = 1;
    let currentPedidoPage = 1;
    let currentClienteOrderBy = 'nome';
    let currentClienteOrderDirection = 'asc';
    let currentCliente = null;

    // Inicializa√ß√£o
    document.addEventListener('DOMContentLoaded', async () => {
      await carregarFiltrosPedidos();
      await carregarEstatisticasClientes();
      await carregarEstatisticasPedidos();
      await buscarClientes();
      await buscarPedidos();
    });

    // Carregar filtros dispon√≠veis para pedidos
    async function carregarFiltrosPedidos() {
      try {
        const response = await primePedidosService.getFiltrosDisponiveis();
        if (response.success) {
          const { statusGeral, statusAprovacao, statusEntrega } = response.data;
          
          // Preencher select de status geral
          const selectStatusGeral = document.getElementById('pedido-status-geral');
          statusGeral.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            selectStatusGeral.appendChild(option);
          });

          // Preencher select de status aprova√ß√£o
          const selectStatusAprovacao = document.getElementById('pedido-status-aprovacao');
          statusAprovacao.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            selectStatusAprovacao.appendChild(option);
          });

          // Preencher select de status entrega
          const selectStatusEntrega = document.getElementById('pedido-status-entrega');
          statusEntrega.forEach(status => {
            const option = document.createElement('option');
            option.value = status;
            option.textContent = status;
            selectStatusEntrega.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Erro ao carregar filtros:', error);
      }
    }

    // Carregar estat√≠sticas de clientes
    async function carregarEstatisticasClientes() {
      try {
        const response = await primeClientesService.getEstatisticasClientes();
        if (response.success) {
          const stats = response.data;
          const container = document.getElementById('cliente-stats');
          
          container.innerHTML = `
            <div class="stat-card" onclick="filtrarClientesPorComportamento('nunca_compraram')" style="cursor: pointer;">
              <div class="value">${stats.totalClientes.toLocaleString()}</div>
              <div class="label">Total Clientes</div>
            </div>
            <div class="stat-card">
              <div class="value">${stats.totalOrcamentos.toLocaleString()}</div>
              <div class="label">Total Or√ßamentos</div>
            </div>
            <div class="stat-card">
              <div class="value">${stats.totalPedidosAprovados.toLocaleString()}</div>
              <div class="label">Pedidos Aprovados</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorComportamento('compra_unica')" style="cursor: pointer;">
              <div class="value">${stats.comportamentoCompra.compraUnica.toLocaleString()}</div>
              <div class="label">Compra √önica</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorComportamento('recompra')" style="cursor: pointer;">
              <div class="value">${stats.comportamentoCompra.recompra.toLocaleString()}</div>
              <div class="label">Recompra</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorComportamento('nunca_compraram')" style="cursor: pointer;">
              <div class="value">${stats.comportamentoCompra.nuncaCompraram.toLocaleString()}</div>
              <div class="label">Nunca Compraram</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorDados('com_email')" style="cursor: pointer;">
              <div class="value">${stats.dadosCadastrais.comEmail.toLocaleString()}</div>
              <div class="label">Com Email</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorDados('com_data_nascimento')" style="cursor: pointer;">
              <div class="value">${stats.dadosCadastrais.comDataNascimento.toLocaleString()}</div>
              <div class="label">Com Data Nascimento</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorDados('com_endereco')" style="cursor: pointer;">
              <div class="value">${stats.dadosCadastrais.comEndereco.toLocaleString()}</div>
              <div class="label">Com Endere√ßo</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorDados('com_cpf')" style="cursor: pointer;">
              <div class="value">${stats.dadosCadastrais.comCpf.toLocaleString()}</div>
              <div class="label">Com CPF</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorDados('com_telefone')" style="cursor: pointer;">
              <div class="value">${stats.dadosCadastrais.comTelefone.toLocaleString()}</div>
              <div class="label">Com Telefone</div>
            </div>
            <div class="stat-card" onclick="filtrarClientesPorDados('com_dados_completos')" style="cursor: pointer;">
              <div class="value">${stats.dadosCadastrais.comDadosCompletos.toLocaleString()}</div>
              <div class="label">Dados Completos</div>
            </div>
            <div class="stat-card">
              <div class="value">R$ ${stats.valorTotalTodosPedidos.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
              <div class="label">Valor Total Or√ßamentos</div>
            </div>
            <div class="stat-card">
              <div class="value">R$ ${stats.ticketMedioTodosPedidos.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
              <div class="label">Ticket M√©dio (Todos)</div>
            </div>
            <div class="stat-card">
              <div class="value">R$ ${stats.valorTotalCompras.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
              <div class="label">Valor Aprovados</div>
            </div>
            <div class="stat-card">
              <div class="value">R$ ${stats.ticketMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
              <div class="label">Ticket M√©dio Aprovados</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas de clientes:', error);
        document.getElementById('cliente-stats').innerHTML = '<div class="error">Erro ao carregar estat√≠sticas</div>';
      }
    }

    // Carregar estat√≠sticas de pedidos
    async function carregarEstatisticasPedidos() {
      try {
        const response = await primePedidosService.getEstatisticasPedidos();
        if (response.success) {
          const stats = response.data;
          const container = document.getElementById('pedido-stats');
          
          container.innerHTML = `
            <div class="stat-card">
              <div class="value">${stats.totalPedidos.toLocaleString()}</div>
              <div class="label">Total Pedidos</div>
            </div>
            <div class="stat-card">
              <div class="value">R$ ${stats.valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
              <div class="label">Valor Total</div>
            </div>
            <div class="stat-card">
              <div class="value">R$ ${stats.valorMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</div>
              <div class="label">Valor M√©dio</div>
            </div>
            <div class="stat-card">
              <div class="value">${stats.porStatusAprovacao.APROVADO || 0}</div>
              <div class="label">Aprovados</div>
            </div>
            <div class="stat-card">
              <div class="value">${stats.porStatusEntrega.ENTREGUE || 0}</div>
              <div class="label">Entregues</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Erro ao carregar estat√≠sticas de pedidos:', error);
        document.getElementById('pedido-stats').innerHTML = '<div class="error">Erro ao carregar estat√≠sticas</div>';
      }
    }

    // Buscar clientes
    window.buscarClientes = async function(page = 1) {
      try {
        currentClientePage = page;
        const search = document.getElementById('cliente-search').value;
        const searchType = document.getElementById('cliente-search-type').value;
        const orderBy = document.getElementById('cliente-order').value;
        const orderDirection = document.getElementById('cliente-direction').value;

        // Atualizar vari√°veis globais de ordena√ß√£o
        currentClienteOrderBy = orderBy;
        currentClienteOrderDirection = orderDirection;

        const container = document.getElementById('cliente-list');
        container.innerHTML = '<div class="loading">Buscando clientes...</div>';

        const response = await primeClientesService.getClientes({
          page,
          pageSize: 20,
          search,
          searchType,
          orderBy,
          orderDirection
        });

        if (response.success) {
          renderClientes(response.data, response.pagination);
        } else {
          container.innerHTML = '<div class="error">Erro ao buscar clientes</div>';
        }
      } catch (error) {
        console.error('Erro ao buscar clientes:', error);
        document.getElementById('cliente-list').innerHTML = '<div class="error">Erro ao buscar clientes</div>';
      }
    };

    // Ordenar por coluna
    window.ordenarPorColuna = async function(column) {
      try {
        console.log(`üîÑ Ordenando por coluna: ${column}`);
        
        // Se for a mesma coluna, alternar dire√ß√£o
        if (currentClienteOrderBy === column) {
          currentClienteOrderDirection = currentClienteOrderDirection === 'asc' ? 'desc' : 'asc';
        } else {
          // Nova coluna, come√ßar com asc
          currentClienteOrderBy = column;
          currentClienteOrderDirection = 'asc';
        }

        // Atualizar selects da interface
        document.getElementById('cliente-order').value = currentClienteOrderBy;
        document.getElementById('cliente-direction').value = currentClienteOrderDirection;

        // Atualizar indicadores visuais
        updateSortIndicators();

        // Buscar com nova ordena√ß√£o
        await buscarClientes(1);

      } catch (error) {
        console.error('Erro ao ordenar por coluna:', error);
      }
    };

    // Atualizar indicadores visuais de ordena√ß√£o
    function updateSortIndicators() {
      // Remover classes de ordena√ß√£o de todos os cabe√ßalhos
      document.querySelectorAll('.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });

      // Adicionar classe ao cabe√ßalho ativo
      const activeTh = document.querySelector(`[data-column="${currentClienteOrderBy}"]`);
      if (activeTh) {
        activeTh.classList.add(currentClienteOrderDirection === 'asc' ? 'sort-asc' : 'sort-desc');
      }
    };

    // Renderizar lista de clientes
    function renderClientes(clientes, pagination) {
      const container = document.getElementById('cliente-list');
      
      if (clientes.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>Nenhum cliente encontrado</h3>
            <p>Tente ajustar os filtros de busca</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th class="sortable" data-column="nome" onclick="ordenarPorColuna('nome')">
                  Nome <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th class="sortable" data-column="cpf_cnpj" onclick="ordenarPorColuna('cpf_cnpj')">
                  CPF/CNPJ <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th class="sortable" data-column="email" onclick="ordenarPorColuna('email')">
                  Email <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th class="sortable" data-column="telefone" onclick="ordenarPorColuna('telefone')">
                  Telefone <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th class="sortable" data-column="total_orcamentos" onclick="ordenarPorColuna('total_orcamentos')">
                  Total Or√ßamentos <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th class="sortable" data-column="valor_total_orcamentos" onclick="ordenarPorColuna('valor_total_orcamentos')">
                  Valor Total <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th class="sortable" data-column="ultima_compra" onclick="ordenarPorColuna('ultima_compra')">
                  √öltima Compra <span class="sort-icon">‚ÜïÔ∏è</span>
                </th>
                <th>Status</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
      `;

      clientes.forEach(cliente => {
        const ultimaCompra = cliente.ultima_compra 
          ? new Date(cliente.ultima_compra).toLocaleDateString('pt-BR')
          : 'Nunca';
        
        // Determinar status do cliente baseado nas compras
        let statusCliente = '';
        let statusClass = '';
        const totalOrcamentos = cliente.total_orcamentos || 0;
        if (totalOrcamentos === 0) {
          statusCliente = 'Nunca comprou';
          statusClass = 'status-cancelado';
        } else if (totalOrcamentos === 1) {
          statusCliente = 'Compra √∫nica';
          statusClass = 'status-orcado';
        } else {
          statusCliente = 'Recompra';
          statusClass = 'status-aprovado';
        }
        
        html += `
          <tr>
            <td><strong>${cliente.nome || 'N/A'}</strong></td>
            <td>${cliente.cpf_cnpj || 'N/A'}</td>
            <td>${cliente.email || 'N/A'}</td>
            <td>${cliente.telefone || 'N/A'}</td>
            <td>${totalOrcamentos}</td>
            <td>R$ ${parseFloat(cliente.valor_total_orcamentos || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
            <td>${ultimaCompra}</td>
            <td><span class="status-badge ${statusClass}">${statusCliente}</span></td>
            <td>
              <button class="btn btn-secondary" onclick="verHistoricoCliente(${cliente.id})">
                üìã Ver Hist√≥rico
              </button>
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      // Adicionar pagina√ß√£o
      if (pagination.totalPages > 1) {
        html += renderPagination(pagination, 'buscarClientes');
      }

      container.innerHTML = html;
      updateSortIndicators(); // Atualizar indicadores visuais
    }

    // Buscar pedidos
    window.buscarPedidos = async function(page = 1) {
      try {
        currentPedidoPage = page;
        const search = document.getElementById('pedido-search').value;
        const statusGeral = document.getElementById('pedido-status-geral').value;
        const statusAprovacao = document.getElementById('pedido-status-aprovacao').value;
        const statusEntrega = document.getElementById('pedido-status-entrega').value;
        const dataInicio = document.getElementById('pedido-data-inicio').value;
        const dataFim = document.getElementById('pedido-data-fim').value;

        const container = document.getElementById('pedido-list');
        container.innerHTML = '<div class="loading">Buscando pedidos...</div>';

        const response = await primePedidosService.getPedidos({
          page,
          pageSize: 20,
          search,
          statusGeral,
          statusAprovacao,
          statusEntrega,
          dataInicio,
          dataFim
        });

        if (response.success) {
          renderPedidos(response.data, response.pagination);
        } else {
          container.innerHTML = '<div class="error">Erro ao buscar pedidos</div>';
        }
      } catch (error) {
        console.error('Erro ao buscar pedidos:', error);
        document.getElementById('pedido-list').innerHTML = '<div class="error">Erro ao buscar pedidos</div>';
      }
    };

    // Renderizar lista de pedidos
    function renderPedidos(pedidos, pagination) {
      const container = document.getElementById('pedido-list');
      
      if (pedidos.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h3>Nenhum pedido encontrado</h3>
            <p>Tente ajustar os filtros de busca</p>
          </div>
        `;
        return;
      }

      let html = `
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>N√∫mero</th>
                <th>Cliente</th>
                <th>Data Cria√ß√£o</th>
                <th>Status Aprova√ß√£o</th>
                <th>Status Entrega</th>
                <th>Valor Total</th>
                <th>A√ß√µes</th>
              </tr>
            </thead>
            <tbody>
      `;

      pedidos.forEach(pedido => {
        const dataCriacao = pedido.data_criacao 
          ? new Date(pedido.data_criacao).toLocaleDateString('pt-BR')
          : 'N/A';
        
        const statusAprovacaoClass = getStatusClass(pedido.status_aprovacao);
        const statusEntregaClass = getStatusClass(pedido.status_entrega);
        
        html += `
          <tr>
            <td><strong>#${pedido.codigo_orcamento_original || 'N/A'}</strong></td>
            <td>${pedido.prime_clientes?.nome || 'N/A'}</td>
            <td>${dataCriacao}</td>
            <td><span class="status-badge ${statusAprovacaoClass}">${pedido.status_aprovacao || 'N/A'}</span></td>
            <td><span class="status-badge ${statusEntregaClass}">${pedido.status_entrega || 'N/A'}</span></td>
            <td>R$ ${parseFloat(pedido.valor_total || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
            <td>
              <button class="btn btn-primary" onclick="verDetalhesPedido(${pedido.id})">
                üëÅÔ∏è Ver Detalhes
              </button>
            </td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      // Adicionar pagina√ß√£o
      if (pagination.totalPages > 1) {
        html += renderPagination(pagination, 'buscarPedidos');
      }

      container.innerHTML = html;
    }

    // Obter classe CSS para status
    function getStatusClass(status) {
      if (!status) return '';
      
      const statusLower = status.toLowerCase();
      if (statusLower.includes('aprovado')) return 'status-aprovado';
      if (statusLower.includes('n√£o') || statusLower.includes('nao')) return 'status-nao-aprovado';
      if (statusLower.includes('aviado')) return 'status-aviado';
      if (statusLower.includes('or√ßado') || statusLower.includes('orcado')) return 'status-orcado';
      if (statusLower.includes('entregue')) return 'status-entregue';
      if (statusLower.includes('cancelado')) return 'status-cancelado';
      return '';
    }

    // Renderizar pagina√ß√£o
    function renderPagination(pagination, functionName) {
      const { page, totalPages } = pagination;
      let html = '<div class="pagination">';
      
      // Bot√£o anterior
      html += `<button ${page === 1 ? 'disabled' : ''} onclick="${functionName}(${page - 1})">¬´ Anterior</button>`;
      
      // P√°ginas
      const startPage = Math.max(1, page - 2);
      const endPage = Math.min(totalPages, page + 2);
      
      if (startPage > 1) {
        html += `<button onclick="${functionName}(1)">1</button>`;
        if (startPage > 2) {
          html += '<span>...</span>';
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        html += `<button class="${i === page ? 'current' : ''}" onclick="${functionName}(${i})">${i}</button>`;
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          html += '<span>...</span>';
        }
        html += `<button onclick="${functionName}(${totalPages})">${totalPages}</button>`;
      }
      
      // Bot√£o pr√≥ximo
      html += `<button ${page === totalPages ? 'disabled' : ''} onclick="${functionName}(${page + 1})">Pr√≥ximo ¬ª</button>`;
      
      html += '</div>';
      return html;
    }

    // Ver hist√≥rico do cliente
    window.verHistoricoCliente = async function(clienteId) {
      try {
        // Buscar dados do cliente
        const clienteResponse = await primeClientesService.getClienteById(clienteId);
        if (!clienteResponse.success) {
          alert('Erro ao carregar dados do cliente');
          return;
        }

        currentCliente = clienteResponse.data;

        // Buscar pedidos do cliente
        const pedidosResponse = await primePedidosService.getPedidosByCliente(clienteId, {
          page: 1,
          pageSize: 50
        });

        if (!pedidosResponse.success) {
          alert('Erro ao carregar hist√≥rico do cliente');
          return;
        }

        // Mostrar modal com hist√≥rico
        mostrarModalHistorico(currentCliente, pedidosResponse.data);

      } catch (error) {
        console.error('Erro ao carregar hist√≥rico:', error);
        alert('Erro ao carregar hist√≥rico do cliente');
      }
    };

    // Ver detalhes do pedido
    window.verDetalhesPedido = async function(pedidoId) {
      try {
        const response = await primePedidosService.getPedidoById(pedidoId);
        if (response.success) {
          mostrarModalDetalhesPedido(response.data);
        } else {
          alert('Erro ao carregar detalhes do pedido');
        }
      } catch (error) {
        console.error('Erro ao carregar detalhes:', error);
        alert('Erro ao carregar detalhes do pedido');
      }
    };

    // Mostrar modal de hist√≥rico do cliente
    function mostrarModalHistorico(cliente, pedidos) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;

      const ultimaCompra = cliente.ultima_compra 
        ? new Date(cliente.ultima_compra).toLocaleDateString('pt-BR')
        : 'Nunca';

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 18px;
          padding: 24px;
          max-width: 800px;
          max-height: 80vh;
          overflow-y: auto;
          margin: 20px;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Hist√≥rico do Cliente</h2>
            <button onclick="this.closest('.modal').remove()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
            ">√ó</button>
          </div>
          
          <div class="client-details">
            <h3>${cliente.nome}</h3>
            <div class="client-info">
              <div><strong>CPF/CNPJ:</strong> <span>${cliente.cpf_cnpj || 'N/A'}</span></div>
              <div><strong>Email:</strong> <span>${cliente.email || 'N/A'}</span></div>
              <div><strong>Telefone:</strong> <span>${cliente.telefone || 'N/A'}</span></div>
              <div><strong>Total Or√ßamentos:</strong> <span>${cliente.total_orcamentos || 0}</span></div>
              <div><strong>Valor Total:</strong> <span>R$ ${parseFloat(cliente.valor_total_orcamentos || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
              <div><strong>√öltima Compra:</strong> <span>${ultimaCompra}</span></div>
            </div>
          </div>

          <h3>Pedidos (${pedidos.length})</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>N√∫mero</th>
                  <th>Data</th>
                  <th>Status</th>
                  <th>Valor</th>
                </tr>
              </thead>
              <tbody>
                ${pedidos.map(pedido => `
                  <tr>
                    <td>#${pedido.codigo_orcamento_original || 'N/A'}</td>
                    <td>${pedido.data_criacao ? new Date(pedido.data_criacao).toLocaleDateString('pt-BR') : 'N/A'}</td>
                    <td><span class="status-badge ${getStatusClass(pedido.status_geral)}">${pedido.status_geral || 'N/A'}</span></td>
                    <td>R$ ${parseFloat(pedido.valor_total || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      modal.className = 'modal';
      document.body.appendChild(modal);
    }

    // Mostrar modal de detalhes do pedido
    function mostrarModalDetalhesPedido(pedido) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
      `;

      const dataCriacao = pedido.data_criacao 
        ? new Date(pedido.data_criacao).toLocaleDateString('pt-BR')
        : 'N/A';

      modal.innerHTML = `
        <div style="
          background: white;
          border-radius: 18px;
          padding: 24px;
          max-width: 600px;
          max-height: 80vh;
          overflow-y: auto;
          margin: 20px;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>Detalhes do Pedido #${pedido.codigo_orcamento_original || 'N/A'}</h2>
            <button onclick="this.closest('.modal').remove()" style="
              background: none;
              border: none;
              font-size: 24px;
              cursor: pointer;
            ">√ó</button>
          </div>
          
          <div class="client-details">
            <h3>Cliente</h3>
            <div class="client-info">
              <div><strong>Nome:</strong> <span>${pedido.prime_clientes?.nome || 'N/A'}</span></div>
              <div><strong>Email:</strong> <span>${pedido.prime_clientes?.email || 'N/A'}</span></div>
              <div><strong>Telefone:</strong> <span>${pedido.prime_clientes?.telefone || 'N/A'}</span></div>
            </div>
          </div>

          <div class="client-details">
            <h3>Pedido</h3>
            <div class="client-info">
              <div><strong>Data Cria√ß√£o:</strong> <span>${dataCriacao}</span></div>
              <div><strong>Status Aprova√ß√£o:</strong> <span class="status-badge ${getStatusClass(pedido.status_aprovacao)}">${pedido.status_aprovacao || 'N/A'}</span></div>
              <div><strong>Status Entrega:</strong> <span class="status-badge ${getStatusClass(pedido.status_entrega)}">${pedido.status_entrega || 'N/A'}</span></div>
              <div><strong>Valor Total:</strong> <span>R$ ${parseFloat(pedido.valor_total || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
              <div><strong>Valor Final:</strong> <span>R$ ${parseFloat(pedido.valor_final || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</span></div>
            </div>
          </div>

          ${pedido.prime_formulas && pedido.prime_formulas.length > 0 ? `
            <h3>F√≥rmulas (${pedido.prime_formulas.length})</h3>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>N√∫mero</th>
                    <th>Descri√ß√£o</th>
                    <th>Posologia</th>
                    <th>Valor</th>
                  </tr>
                </thead>
                <tbody>
                  ${pedido.prime_formulas.map(formula => `
                    <tr>
                      <td>${formula.numero_formula || 'N/A'}</td>
                      <td>${formula.descricao || 'N/A'}</td>
                      <td>${formula.posologia || 'N/A'}</td>
                      <td>R$ ${parseFloat(formula.valor_formula || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 })}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          ` : ''}
        </div>
      `;

      modal.className = 'modal';
      document.body.appendChild(modal);
    }

    // Filtrar clientes por comportamento de compra
    window.filtrarClientesPorComportamento = async function(tipoComportamento) {
      try {
        console.log(`üîç Filtrando clientes por comportamento: ${tipoComportamento}`);
        
        const container = document.getElementById('cliente-list');
        container.innerHTML = '<div class="loading">Filtrando clientes...</div>';

        const response = await primeClientesService.getClientesPorComportamento(tipoComportamento, {
          page: 1,
          pageSize: 20,
          search: '',
          orderBy: 'nome',
          orderDirection: 'asc'
        });

        if (response.success) {
          renderClientes(response.data, response.pagination);
          
          // Atualizar o placeholder da busca
          const searchInput = document.getElementById('cliente-search');
          const searchType = document.getElementById('cliente-search-type');
          searchInput.placeholder = `Filtrando: ${getComportamentoLabel(tipoComportamento)}`;
          searchType.value = 'todos';
        } else {
          container.innerHTML = '<div class="error">Erro ao filtrar clientes</div>';
        }
      } catch (error) {
        console.error('Erro ao filtrar clientes por comportamento:', error);
        document.getElementById('cliente-list').innerHTML = '<div class="error">Erro ao filtrar clientes</div>';
      }
    };

    // Filtrar clientes por dados cadastrais
    window.filtrarClientesPorDados = async function(tipoDado) {
      try {
        console.log(`üîç Filtrando clientes por dados: ${tipoDado}`);
        
        const container = document.getElementById('cliente-list');
        container.innerHTML = '<div class="loading">Filtrando clientes...</div>';

        const response = await primeClientesService.getClientesPorDadosCadastrais(tipoDado, {
          page: 1,
          pageSize: 20,
          search: '',
          orderBy: 'nome',
          orderDirection: 'asc'
        });

        if (response.success) {
          renderClientes(response.data, response.pagination);
          
          // Atualizar o placeholder da busca
          const searchInput = document.getElementById('cliente-search');
          const searchType = document.getElementById('cliente-search-type');
          searchInput.placeholder = `Filtrando: ${getDadosLabel(tipoDado)}`;
          searchType.value = 'todos';
        } else {
          container.innerHTML = '<div class="error">Erro ao filtrar clientes</div>';
        }
      } catch (error) {
        console.error('Erro ao filtrar clientes por dados:', error);
        document.getElementById('cliente-list').innerHTML = '<div class="error">Erro ao filtrar clientes</div>';
      }
    };

    // Obter label do comportamento
    function getComportamentoLabel(tipo) {
      const labels = {
        'nunca_compraram': 'Nunca Compraram',
        'compra_unica': 'Compra √önica',
        'recompra': 'Recompra'
      };
      return labels[tipo] || tipo;
    }

    // Obter label dos dados
    function getDadosLabel(tipo) {
      const labels = {
        'com_email': 'Com Email',
        'sem_email': 'Sem Email',
        'com_data_nascimento': 'Com Data Nascimento',
        'sem_data_nascimento': 'Sem Data Nascimento',
        'com_endereco': 'Com Endere√ßo',
        'sem_endereco': 'Sem Endere√ßo',
        'com_cpf': 'Com CPF',
        'sem_cpf': 'Sem CPF',
        'com_telefone': 'Com Telefone',
        'sem_telefone': 'Sem Telefone',
        'com_dados_completos': 'Dados Completos'
      };
      return labels[tipo] || tipo;
    }

    // Event listeners para busca em tempo real
    document.getElementById('cliente-search').addEventListener('input', debounce(() => {
      console.log('üîç Busca de cliente alterada');
      buscarClientes(1);
    }, 500));

    document.getElementById('pedido-search').addEventListener('input', debounce(() => {
      console.log('üîç Busca de pedido alterada');
      buscarPedidos(1);
    }, 500));

    // Event listeners para mudan√ßas nos filtros
    document.getElementById('cliente-search-type').addEventListener('change', () => {
      console.log('üîÑ Tipo de busca alterado');
      buscarClientes(1);
    });

    document.getElementById('cliente-order').addEventListener('change', () => {
      console.log('üîÑ Ordena√ß√£o alterada');
      buscarClientes(1);
    });

    document.getElementById('cliente-direction').addEventListener('change', () => {
      console.log('üîÑ Dire√ß√£o alterada');
      buscarClientes(1);
    });

    // Fun√ß√£o debounce para evitar muitas requisi√ß√µes
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>
